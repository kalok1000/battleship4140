<!DOCTYPE html>
<html>

<head>
	<link rel="stylesheet" href="/stylesheets/style.css" />
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />
	<!-- jQuery library -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
	<!-- Latest compiled JavaScript -->
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	<script src="/javascripts/js.cookie.js"></script>
	<script src="/javascripts/konva.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
</head>
<body>
	<embed loop="true" src="/music/battle.mp3" hidden="true" type="audio/midi"></embed>
	<div class="panel panel-danger">
		<div class="panel-heading">BATTLE</div>
		<div class="panel-body">
			<div class="col-md-3">
				<div class="row">Your Placing</div>
				<div id="container" align="center" class="row"></div>
				<div class="row" align="center"><h4>Your Ships Down : <span id="yourShipsDown">0</span>/5</h4></div>
				<div class="row"" align="center"><h4>Opponent's Ships Down : <span id="oppShipsDown">0</span>/5</h4></div>
			</div>
			<div id="container2" align="center" class="col-md-6"></div>
		</div>
	</div>
	<script>
		var socket = io();
		var url = window.location.href.split('/')
		var roomId = url[url.length-3];
		socket.emit('register',roomId);
	
		var arrShip = JSON.parse(Cookies.get('ships'));
		
		for(var z = 0;z < arrShip.length;z++){
			arrShip[z].hit = 0;
		}
		
		var oppShips;
		var width = 252;
		var height = 252;
		var oppWidth = 420;
		var oppHeight = 420;
		var sRatio = 1;
		var yourShipsDown = 0;
		var oppShipsDown = 0;
		
		var stage = new Konva.Stage({
		  container: 'container',
		  width: width,
		  height: height
		});

		var layer1 = new Konva.Layer();
		var layer2 = new Konva.Layer();
		var layer3 = new Konva.Layer();
		
		var oppStage = new Konva.Stage({
			container: 'container2',
			width: oppWidth,
			height: oppHeight
		});
				
		var oppLayer1 = new Konva.Layer();
		var oppLayer2 = new Konva.Layer();
		var oppLayer3 = new Konva.Layer();
				
		var mapX = 0;
		var mapY = 0;
		var oppMapX = 0;
		var oppMapY = 0;
		var paddingTop = 10;
		var shipBlockSize = 38;
		
		function sound(src) {
			this.sound = document.createElement("audio");
			this.sound.src = src;
			this.sound.setAttribute("preload", "auto");
			this.sound.setAttribute("controls", "none");
			this.sound.style.display = "none";
			document.body.appendChild(this.sound);
			this.play = function(){
				this.sound.play();
			}
			this.stop = function(){
				this.sound.pause();
			}
		}
	
		function drawMap(mx,my,layer){
			for(var i=0;i <= 400;i+=40){
				var vLine = new Konva.Line({
				  points: [5, 5, 5, 405],
				  stroke: 'white',
				  strokeWidth: 5,
				  lineCap: 'round',
				  lineJoin: 'round'
				});

				vLine.move({
				  x : i + mx,
				  y : 5 + my
				});

				layer.add(vLine);
			}
			
			for(var i=0;i <= 400;i+=40){
				var hLine = new Konva.Line({
				  points: [5, 5, 405, 5],
				  stroke: 'white',
				  strokeWidth: 5,
				  lineCap: 'round',
				  lineJoin: 'round'
				});

				hLine.move({
				  x : 0 + mx,
				  y : i + 5 + my
				});

				layer.add(hLine);
			}
		}
		
		function drawShip(sx,sy,block,direction,lastId){
			var blockH = block;
			var blockW = 1;
			var id = lastId;
			if(direction=="E" || direction=="W"){
				blockH = 1;
				blockW = block;
			}
			var h = shipBlockSize*blockH, w = shipBlockSize*blockW;
			var imgPath = 'ship' + direction + '.png';
		
			var shipImg = new Image();
			shipImg.onload = function(){
				var img = new Konva.Image({
					x : mapX + 7 + sx*40,
					y : mapY + paddingTop + sy*40,
					image : shipImg,
					width : w,
					height : h
				});
				
				layer2.add(img);
				stage.add(layer2);
			}
			
			shipImg.src = "/images/" + imgPath;
		}
		
		function scaleStage(ratio){
			layer2.scale({
				x:ratio,
				y:ratio
			});
			layer2.draw();
			layer1.scale({
				x:ratio,
				y:ratio
			});
			layer1.draw();
			layer3.scale({
				x:ratio,
				y:ratio
			});
			layer3.draw();
			stage.scale({
				x:ratio,
				y:ratio
			});
			stage.draw();
			stage.setHeight(height*sRatio);
		}	
		
		function miss(x,y,attack){
			var missImg = new Image();
			missImg.onload = function(){
				var img = new Konva.Image({
					x : 7 + x*40,
					y : paddingTop + y*40,
					image : missImg,
					width : shipBlockSize,
					height : shipBlockSize
				});
				if(attack){
					oppLayer2.add(img);
					oppStage.add(oppLayer2);
				}else{
					layer2.add(img);
					stage.add(layer2);
				}
			}
			
			missImg.src = "/images/water.png";
			(new sound("/sounds/splash.mp3")).play();
		}
		
		function hit(x,y,attack){
			var hitImg = new Image();
			hitImg.onload = function(){
				var img = new Konva.Image({
					x : 7 + x*40,
					y : paddingTop + y*40,
					image : hitImg,
					width : shipBlockSize,
					height : shipBlockSize
				});
				if(attack){
					oppLayer2.add(img);
					oppStage.add(oppLayer2);
				}else{
					layer2.add(img);
					stage.add(layer2);
				}
			}
			
			hitImg.src = "/images/explosion.png";
			(new sound("/sounds/explosion.mp3")).play();
		}
		
		function explode(x,y){
			var success = false;
			for(var i = 0;i < arrShip.length;i++){
				var direction = arrShip[i].direction;
				var block = arrShip[i].block;
				var sx = arrShip[i].x;
				var sy = arrShip[i].y;
				
				if(((direction == "E" || direction == "W") && sx <= x && x < sx + block && sy == y) || ((direction == "N" || direction == "S") && sy <= y && y < sy + block && sx == x)){
					hit(x,y,false);
					arrShip[i].hit += 1;
					if(arrShip[i].hit == arrShip[i].block){
						yourShipsDown += 1;
						$('#yourShipsDown').text(yourShipsDown);
						if(yourShipsDown == 5){
							stage.listening(false);
							oppStage.listening(false);
						}
					}
					return true;
				}
			}
			miss(x,y,false);
			return false;
		}
		
		var bgImg = new Image();
		bgImg.onload = function(){
			var img = new Konva.Image({
				x : mapX + 5,
				y : mapY + 10,
				image : bgImg,
				width : 400,
				height : 400,
				opacity : 0.8
			});
			
			layer3.add(img);
			stage.add(layer3);
			layer3.moveDown().moveDown();
		}
		
		bgImg.src = "/images/sea.jpg";
		
		var bgImg2 = new Image();
		bgImg2.onload = function(){
			var img2 = new Konva.Image({
				x : oppMapX + 5,
				y : oppMapY + 10,
				image : bgImg2,
				width : 400,
				height : 400,
				opacity : 0.8
			});
			
			oppLayer3.add(img2);
			oppStage.add(oppLayer3);
			oppLayer3.moveDown().moveDown();
		}

		bgImg2.src = "/images/sea.jpg";
		
		drawMap(mapX,mapY,layer1);
		drawMap(oppMapX,oppMapY,oppLayer1);
		
		for(var i = 0;i < arrShip.length;i++){
			var ship = arrShip[i];
			drawShip(ship.x,ship.y,ship.block,ship.direction,-1);
		}
		stage.add(layer1);
		oppStage.add(oppLayer1);
		scaleStage(0.7);
		oppStage.add(oppLayer2);
		
		oppStage.on('click',function(){
				var mousePos = oppStage.getPointerPosition();
				var x = mousePos.x;
				var y = mousePos.y;
				var nx = Math.floor((x-5)/40);
				var ny = Math.floor((y-10)/40);
				if(nx >= 0 && nx < 10 && ny >= 0 && ny < 10){
					socket.emit('attack',[nx,ny]);
				}
		});
		
		socket.on('playerConnected',function(){

		});
		
		socket.on('playerDisconnected',function(){
			alert('The opponent left!');
			var host = window.location.href.split('/')[0];
			location.href = host + '/' + roomId + '/ship/';
		});
		
		socket.on('damage',function(data){
			var x = data[0];
			var y = data[1];
			var success = explode(x,y);
			if(success){
				socket.emit('success',[x,y,yourShipsDown]);
				if(yourShipsDown == 5){
					alert('You lose!');
				}
			}else{
				socket.emit('fail',[x,y]);	
			}
		});
		
		socket.on('success',function(data){
			var x = data[0];
			var y = data[1];
			hit(x,y,true);
			$('#oppShipsDown').text(data[2]);
			if(data[2] == 5){
				alert('You win!');
				stage.listening(false);
				oppStage.listening(false);
			}
		});
		
		socket.on('fail',function(data){
			var x = data[0];
			var y = data[1];
			miss(x,y,true);
		});
		
		var ptrImg = new Image();
		ptrImg.onload = function(){
				var img = new Konva.Image({
					x : 7 + 0*40,
					y : paddingTop + 0*40,
					image : ptrImg,
					width : shipBlockSize,
					height : shipBlockSize
				});
				oppLayer2.add(img);
				oppStage.add(oppLayer2);
			}
			
		ptrImg.src = "/images/explosion.png";
		
		oppStage.on('mouseover', function() {
			document.body.style.cursor = 'pointer';
			var mousePos = oppStage.getPointerPosition();
			var x = mousePos.x;
			var y = mousePos.y;
			
			var nx = Math.floor((x-5)/40);
			var ny = Math.floor((y-10)/40);
			if(nx >= 0 && nx < 10 && ny >= 0 && ny < 10){
				ptrImg.position({
					x: nx,
					y: ny
				});
			}
		});
				
		oppStage.on('mouseout', function() {
			document.body.style.cursor = 'default';
		});
		
		window.onload = function(event){
			
		}
		
		window.onresize = function(event){
			
		}
	</script>
</body>
</html>